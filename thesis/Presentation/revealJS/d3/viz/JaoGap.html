<!DOCTYPE html>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v7.min.js"></script>
<body style="overflow: hidden;">
  <script>

    let column = document.body;
    let height = 400;
    let width = 400;

    let radius = 75
    let offset = 300

    // Append SVG and group to transform by the margins
    var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr('id', 'exampleViz');
    // Define the scales
    var xscale = d3.scaleLinear()
      .range([0, width])
      .domain([-2, 2]);

    var yscale = d3.scaleLinear()
      .range([0, height/1.2])
      .domain([-2, 2]);

    const defs = svg.append("defs");

    // Define a clipping path that includes a sine wave
    defs.append("clipPath")
        .attr("id", "wave-clip")
      .append("path")
        .attr("id", "wave-path-1")
    defs.append("clipPath")
        .attr("id", "wave-clip2")
      .append("path")
        .attr("id", "wave-path-2")


    const waveHeight = 2.5; // Height of the wave peaks
    let yOffset = 200; // Initial vertical offset of the wave center from the top of the SVG
    const waveSpeed = 1000; // Speed of the bobbing, in milliseconds

    // Append a blue circle to the SVG, using the clipping path

    // Function to generate wave path string
    function generateWavePath(yOffset, amplitude) {
      const points = [];
      const waveLength = 100; // Length of one wave cycle
      for (let x = 0; x <= width; x += 10) {
        const y = yOffset + amplitude * Math.sin(2 * Math.PI * x / waveLength);
        points.push([x, y]);
      }
      return "M 0," + (height + 50) + " L " + points.map(p => `${p[0]},${p[1]}`).join(" L") + ` L ${width},${height} Z`;
    }

    // Initial setup of the wave path
    svg.select("#wave-path-1")
      .attr("d", generateWavePath(yOffset, waveHeight));
    svg.select("#wave-path-2")
      .attr("d", generateWavePath(yOffset+100, waveHeight));


    // Function to animate the wave bobbing
    function animateWave(count, dy, i, interval, id, mya, rt, rDepthLevel, brm, ooffset=0) {
      var totalStepsNeeded = Math.abs((200-mya-ooffset)/dy)
      var sign = dy/Math.abs(dy)
      var l = rt/totalStepsNeeded;
      if (dy == 0){
        totalStepsNeeded = Infinity;
        l = 0;
        sign = 1;
      }
      console.log(`Recursion Depth ${rDepthLevel}, dy: ${dy}, totalSteps: ${totalStepsNeeded}, sign: ${sign}, count: ${count}`);

      if (count >= totalStepsNeeded) {
        interval.stop();
        let count = 0;
        let internalInterval = d3.interval(function() {
          if (id == "#wave-path-1"){
            if (rDepthLevel == 0) {
              var ndy = -0.1;
              mya = 190
              var roffset = totalStepsNeeded*dy;
              var rbrm = 0.875;
            }
            else {
              var ndy = 0;
              var roffset = 0;
              var rbrm = 0.7
            }
          }
          else {
            var rbrm = 1.75
            var roffset = (totalStepsNeeded*dy)-100
            var ndy = 0;
          }
          if (rDepthLevel < 1){
            animateWave(count, ndy, i, internalInterval, id, mya, rt, rDepthLevel+1, rbrm, ooffset=roffset)
          }
          count++;
        }, i)
        if (id == "#wave-path-1" & rDepthLevel == 0){
          svg.select("#he3-env")
          .transition()
            .duration(300)
            .style('opacity', 1)
          let count2 = 0;
          let interval2 = d3.interval(function(){
            animateWave(count2, 0.1, i, interval2, "#wave-path-2", 260, 0.875, rDepthLevel+1, 0.875, ooffset=-100)
            count2++;
          })
        }
      }

      const bobbingAmplitude = 5; // Max vertical movement of the center
      yOffset = (200 - (count*dy) - ooffset) + bobbingAmplitude * (Math.sin(Date.now() * 2 * Math.PI / waveSpeed + count*(Math.PI/50)) + Math.sin((1/4) * Date.now() * 2 * Math.PI / waveSpeed));
      var waveHeight = 2+ Math.sin(Date.now() * 2 * Math.PI / waveSpeed) + Math.sin(1/3 * Date.now() * 2 * Math.PI / waveSpeed)
      svg.select(id)
        .attr("d", generateWavePath(yOffset, waveHeight));
      if (id == "#wave-path-1"){
        svg.select("#core")
        .transition()
          .duration(i)
          .attr('r', (radius*(brm + (sign * count * l))))
        svg.select("#he3")
        .transition()
          .duration(i)
          .attr('r', (radius*(brm + (sign * count * l))))
      }
    }

    // Start animation
    // d3.interval(animateWave, 10);  // Update every 50 milliseconds 

    svg.append("circle")
      .attr('cx', xscale(0))
      .attr('cy', yscale(0))
      .attr('r', radius)
      .style('fill', 'red')
      .style('opacity', 0)
      .attr('id', 'envelope')
    .transition()
      .duration(500)
      .style('opacity', 1)
    svg.append("circle")
        .attr("cx", xscale(0))
        .attr("cy", yscale(0))
        .attr("r", radius*1.75)
        .attr("fill", "blue")
        .attr("clip-path", "url(#wave-clip2)")
        .style('opacity', 1)
        .attr('id', 'he3-env');
    svg.append("circle")
      .attr('cx', xscale(0))
      .attr('cy', yscale(0))
      .attr('r', radius*0.5)
      .style('fill', 'green')
      .style('opacity', 0)
      .attr('id', 'rad')
    .transition()
      .duration(500)
      .style('opacity', 1)
    svg.append("circle")
      .attr('cx', xscale(0))
      .attr('cy', yscale(0))
      .attr('r', radius*0.4)
      .style('fill', '#ccaa00')
      .style('opacity', 0)
      .attr('id', 'core')
    .transition()
      .duration(500)
      .style('opacity', 1)

    function getxy(r, theta) {
      return {'x': r * Math.cos(theta), 'y': r*Math.sin(theta)}
    }

    svg.append("text")
      .attr('x', xscale(0.8))
      .attr('y', yscale(0))
      .attr('id', 'coreLabel')
      .attr('class', 'JaoLabel')
      .style('fill', '#ccaa00')
      .style('font-family', 'times')
      .style('font-size', '20px')
      .text('Convective')
      .style('opacity', 0)
    svg.append("text")
      .attr('x', xscale(0.8))
      .attr('y', yscale(0.23))
      .attr('id', 'coreLabel')
      .attr('class', 'JaoLabel')
      .style('fill', '#ccaa00')
      .style('font-family', 'times')
      .style('font-size', '20px')
      .text('Core')
      .style('opacity', 0)

    pos = getxy(1.2, Math.PI/2)
    svg.append("text")
      .attr('x', xscale(pos.x-0.3))
      .attr('y', yscale(pos.y))
      .attr('id', 'coreLabel')
      .attr('class', 'JaoLabel')
      .style('fill', 'green')
      .style('font-family', 'times')
      .style('font-size', '24px')
      .text('Radiative Zone')
      .style('opacity', 0)

    pos = getxy(1.1, -Math.PI/2)
    svg.append("text")
      .attr('x', xscale(pos.x-0.3))
      .attr('y', yscale(pos.y))
      .attr('id', 'coreLabel')
      .attr('class', 'JaoLabel')
      .style('fill', 'red')
      .style('font-family', 'times')
      .style('font-size', '24px')
      .text('Convective Envelope')
      .style('opacity', 0)
    

    svg.append("circle")
        .attr("cx", xscale(0))
        .attr("cy", yscale(0))
        .attr("r", radius*0.7)
        .attr("fill", "blue")
        .attr("clip-path", "url(#wave-clip)")
        .style('opacity', 0)
        .attr('id', 'he3');
      

    var _transitions = [
      {
        transitionForward: () => {
          svg.selectAll(".JaoLabel")
          .transition()
            .duration(500)
            .style('opacity', 1)
        },
        index: 0
      },
      {
        transitionForward: () => {
          svg.selectAll(".JaoLabel")
          .transition()
            .duration(500)
            .style('opacity', 0)
          svg.select('#core')
          .transition()
            .duration(1000)
            .attr('r', radius*0.7)
          svg.select('#rad')
          .transition()
            .duration(1000)
            .attr('r', radius*0.875)
          svg.select('#envelope')
          .transition()
            .duration(1000)
            .attr('r', radius*1.75)
          let count = 0
          svg.select('#he3')
          .transition()
            .duration(500)
            .delay(1000)
            .style('opacity', 1)
            .on('end', function() {let interval = d3.interval(function() {
              animateWave(count, 0.1, 10, interval, '#wave-path-1', 150, 0.175, 0, 0.7)
              count++;
            }, 10) })
          
        }
      },
      {
        transitionForward: () => {
          svg.select("#core")
          .transition()
            .duration(500)
            .attr('r', radius*0.7)
          svg.select("#rad")
          .transition()
            .duration(500)
            .attr('r', radius*0.875)
          svg.select("#envelope")
          .transition()
            .duration(500)
            .attr('r', radius*1.75)
          svg.select("#he3")
          .transition()
            .duration(500)
            .style('opacity', 0)

        }
      }
    ];
    </script>
</body>

